<html>
<head>
  <title>IOT</title>
  <basefont face="Segoe UI" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/308919 (en-US, DDL); Windows/6.3.0 (Win64);"/>
  <style>
    body, td {
      font-family: Segoe UI;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="5080"/>
<h1>IOT</h1>

<div>
<span><div><div><span style="font-weight: bold; font-size: 14pt;">s33k3r :</span></div><div><span style="font-weight: bold;">Description:</span></div><div><span style="font-weight: bold; color: rgb(188, 0, 88);">You work at the NSA, and recently there was security breach in the network devices of Grand Coulee Dam hydroelectricpower plant. Transformers were shut off remotely since hackers had got access to PLC/SCADA systems via a backdoored WiFi router in one of the employee's office who received a phishing email containing malware which infected his computer and scanned internal network devices with default admin passwords. As a malware analyst you carefully examined the behavior of the program and found the download URL of encrypted firmware file which installed a backdoor on WiFI router for remote access. Your task is to decrypt the firmware image and find the backdoor.</span></div><div><br/></div><div><span style="font-weight: bold;">End goal: Once you find backdoor binary just run it on 64-bit Linux machine, flag will be printed out.</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-weight: bold; font-size: 10pt;">binwalk before decryption :</span></div><div><span style="font-weight: bold;"><img src="IOT_files/Image.png" type="image/png" data-filename="Image.png" width="569"/></span></div><div><span style="font-weight: bold; color: rgb(45, 79, 201);">[ To scan the files Recursively -M, –matryoshka ]</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-weight: bold;">hexdump -C -v stage2.bin | head -n 10</span></div><div><span style="font-weight: bold;">hexdump -C -v stage2.bin | tail -n 5</span></div><div><img src="IOT_files/Image [1].png" type="image/png" data-filename="Image.png" width="636"/></div><div><br/></div><div><span style="font-weight: bold;">After bit of research found out that this might be XOR encrypted .</span></div><div><br/></div><div><span style="font-weight: bold;">Tried to decrypt it using :</span></div><div><a href="https://github.com/Apress/iot-hack-hdbk-practical-guide/blob/master/Chapter%207/decryptxor.py" style="font-weight: bold;">https://github.com/Apress/iot-hack-hdbk-practical-guide/blob/master/Chapter%207/decryptxor.py</a><span style="font-weight: bold;"> </span></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font color="#8600A4"><b>import os                 #</b>decryptxor.py</font></div><div><b><font color="#8600A4">import sys</font></b></div><div><b><font color="#8600A4"><br/></font></b></div><div><b><font color="#8600A4"><br/></font></b></div><div><b><font color="#8600A4">key = &quot;746f6f72&quot;.decode(&quot;hex&quot;)</font></b></div><div><b><font color="#8600A4">data = sys.stdin.read()</font></b></div><div><b><font color="#8600A4"><br/></font></b></div><div><b><font color="#8600A4"><br/></font></b></div><div><b><font color="#8600A4">r = &quot;&quot;</font></b></div><div><b><font color="#8600A4">for i in range(len(data)):</font></b></div><div><b><font color="#8600A4">        c = chr(ord(data[i]) ^ ord(key[i % len(key)]))</font></b></div><div><b><font color="#8600A4">        r += c</font></b></div><div><b><font color="#8600A4"><br/></font></b></div><div><b><font color="#8600A4"><br/></font></b></div><div><b><font color="#8600A4">sys.stdout.write(r)</font></b></div></div><div><br/></div><div><span style="font-weight: bold;">key used : </span> <span style="font-weight: bold; color: rgb(134, 0, 164);">toor</span> <span style="font-weight: bold;">:</span> <span style="font-weight: bold; color: rgb(227, 0, 0);">746f6f72</span></div><div><br/></div><div><span style="font-weight: bold; font-size: 11pt;">cat stage2.bin | python decryptxor.py &gt; out.bin</span></div><div><br/></div><div><span style="font-weight: bold; color: rgb(65, 173, 28);">Decryption Done!!</span></div><div><br/></div><div><span style="font-size: 10pt; font-weight: bold;">binwalk</span> <span style="font-size: 10pt; font-weight: bold; color: rgb(156, 0, 76);">after</span> <span style="font-size: 10pt; font-weight: bold;">decryption :</span></div><div><span style="font-weight: bold;"><img src="IOT_files/Image [2].png" type="image/png" data-filename="Image.png"/></span></div><div><br/></div><div><span style="font-weight: bold; color: rgb(28, 51, 135);">Will extract now : </span><span style="font-weight: bold;"> </span><span style="font-weight: bold; font-size: 11pt;">binwalk -e out.bin</span></div><div><span style="font-weight: bold; font-size: 10pt;"><img src="IOT_files/Image [3].png" type="image/png" data-filename="Image.png"/></span></div><div><span style="font-weight: bold; font-size: 10pt;">Found these three .</span></div><div><font style="font-size: 10pt;"><br/></font></div><div><span style="font-weight: bold; font-size: 10pt;">Found a</span> <span style="font-weight: bold; font-size: 10pt; color: rgb(134, 0, 164);">s</span><span style="font-weight: bold; font-size: 10pt; color: rgb(134, 0, 164);">quashfs</span> <span style="font-weight: bold; font-size: 10pt;">file</span> <span style="font-weight: bold; font-size: 10pt; color: rgb(79, 0, 154);">:   </span><span style="font-weight: bold; color: rgb(79, 0, 154);">Squashfs is a compressed read-only file system for Linux .</span></div><div><br/></div><div><span style="font-weight: bold;">tried to use</span> <span style="font-weight: bold; color: rgb(156, 0, 76);">unsquash</span><span style="font-weight: bold;"> </span><span style="font-weight: bold;">to unpackage it</span><span style="font-weight: bold;">  :   but failed</span></div><div><span style="font-weight: bold;"><img src="IOT_files/Image [4].png" type="image/png" data-filename="Image.png"/></span></div><div><br/></div><div><span style="font-weight: bold;">Checking magic bytes :     </span><span style="font-weight: bold; color: rgb(156, 0, 76);">shsq</span></div><div><span style="font-weight: bold;"><img src="IOT_files/Image [5].png" type="image/png" data-filename="Image.png"/></span></div><div><br/></div><div><a href="https://poppopret.org/2012/04/18/netgear-unsquashfs-c-version-1-3/">https://poppopret.org/2012/04/18/netgear-unsquashfs-c-version-1-3/</a></div><div><a href="https://github.com/ReFirmLabs/binwalk/issues/290" style="font-weight: bold;">https://github.com/ReFirmLabs/binwalk/issues/290</a></div><div><br/></div><div><span style="font-weight: bold;">So we found a new tool called sasquatch : </span><span style="font-weight: bold; color: rgb(134, 0, 164);">The</span> <span style="font-weight: bold; color: rgb(65, 173, 28);">sasquatch</span> <span style="font-weight: bold; color: rgb(134, 0, 164);">project is a set of patches to the standard unsquashfs utility (part of squashfs-tools) that attempts to add support for as many hacked-up vendor-specific SquashFS implementations as possible.</span></div><div><br/></div><div><a href="https://github.com/devttys0/sasquatch" style="font-weight: bold;">https://github.com/devttys0/sasquatch</a></div><div><br/></div><div><span style="font-weight: bold; color: rgb(26, 144, 185);">Remember to place the patches folder. </span></div><div><br/></div><div><span style="font-weight: bold;">apt-get install build-essential liblzma-dev liblzo2-dev zlib1g-dev</span></div><div><br/></div><div><span style="font-weight: bold;">./build.sh</span></div><div><br/></div><div><span style="font-weight: bold;">sasquatch 14FE1C.squashfs</span></div><div><br/></div><div><span style="color: rgb(134, 0, 164);">It worked!!!!!</span></div><div><span style="color: rgb(134, 0, 164);"><img src="IOT_files/Image [6].png" type="image/png" data-filename="Image.png"/></span></div><div><br/></div><div><span style="color: rgb(222, 87, 0);">We found a file named backdoor :</span></div><div><span style="font-weight: bold;">ls * | less</span></div><div><img src="IOT_files/Image [7].png" type="image/png" data-filename="Image.png" style="color: rgb(134, 0, 164);"/></div><div><br/></div><div><b><font style="font-size: 14pt;">POC :</font></b> <font color="#8600A4" style="font-size: 14pt;">After running that backdoor file we get out flag .</font></div><div><b><font style="color: rgb(227, 0, 0); font-size: 14pt;">./backdoor</font></b></div><div><img src="IOT_files/Image [8].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><b><font style="font-size: 14pt;">FLAG :  <font style="color: rgb(227, 0, 0);">flag{winner_winner_backdoor_dinner!}</font></font></b></div><div><b><font style="font-size: 14pt;"><font style="color: rgb(227, 0, 0);"><br/></font></font></b></div><hr/><div><br/></div></div></span>
</div></body></html> 